import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,e,o as p}from"./app-CqFg8cUi.js";const t={};function l(c,n){return p(),a("div",null,n[0]||(n[0]=[e(`<p>å¥½çš„ï¼è®©æˆ‘ä¸ºä½ è¯¦ç»†ä»‹ç»æˆ‘ä»¬å·²ç»å®Œæˆçš„ <strong>Auth æ¨¡å—</strong>çš„æŠ€æœ¯æ¶æ„å’Œå®ç°åŸç†ï¼š</p><hr><h1 id="ğŸ”-auth-æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ" tabindex="-1"><a class="header-anchor" href="#ğŸ”-auth-æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ"><span>ğŸ” Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ</span></a></h1><h2 id="ğŸ“š-ç›®å½•" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›®å½•"><span>ğŸ“š ç›®å½•</span></a></h2><ol><li><a href="https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#1-%E6%A8%A1%E5%9D%97%E6%9E%B6%E6%9E%84%E6%80%BB%E8%A7%88" target="_blank" rel="noopener noreferrer">æ¨¡å—æ¶æ„æ€»è§ˆ</a></li><li><a href="https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#2-spring-security-%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener noreferrer">Spring Security æ ¸å¿ƒæœºåˆ¶</a></li><li><a href="https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#3-jwt-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">JWT è®¤è¯æµç¨‹</a></li><li><a href="https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#4-mybatis-plus-%E6%95%B0%E6%8D%AE%E5%B1%82" target="_blank" rel="noopener noreferrer">MyBatis-Plus æ•°æ®å±‚</a></li><li><a href="https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#5-%E6%9C%8D%E5%8A%A1%E5%B1%82%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91" target="_blank" rel="noopener noreferrer">æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘</a></li><li><a href="https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#6-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3" target="_blank" rel="noopener noreferrer">å®‰å…¨ç‰¹æ€§è¯¦è§£</a></li><li><a href="https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#7-%E5%AE%8C%E6%95%B4%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">å®Œæ•´è¯·æ±‚æµç¨‹</a></li></ol><hr><h2 id="_1-æ¨¡å—æ¶æ„æ€»è§ˆ" tabindex="-1"><a class="header-anchor" href="#_1-æ¨¡å—æ¶æ„æ€»è§ˆ"><span>1. æ¨¡å—æ¶æ„æ€»è§ˆ</span></a></h2><h3 id="ğŸ“¦-åˆ†å±‚æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ“¦-åˆ†å±‚æ¶æ„"><span>ğŸ“¦ <strong>åˆ†å±‚æ¶æ„</strong></span></a></h3><div class="language-text line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="text" style="--vp-collapsed-lines:15;"><pre><code class="language-text"><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  Controller Layer (æ§åˆ¶å±‚)           â”‚  â† REST API æ¥å£</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚  Service Layer (ä¸šåŠ¡å±‚)              â”‚  â† ä¸šåŠ¡é€»è¾‘å¤„ç†</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚  Mapper Layer (æ•°æ®è®¿é—®å±‚)           â”‚  â† æ•°æ®åº“æ“ä½œ</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚  Entity Layer (å®ä½“å±‚)               â”‚  â† æ•°æ®æ¨¡å‹</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span>
<span class="line">           â†• (è´¯ç©¿å„å±‚)</span>
<span class="line"></span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚  Security Layer (å®‰å…¨å±‚)             â”‚</span>
<span class="line">â”‚  - JWT Filter                       â”‚</span>
<span class="line">â”‚  - Authentication Provider          â”‚</span>
<span class="line">â”‚  - UserDetailsService              â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h3 id="ğŸ—‚ï¸-æ–‡ä»¶ç»„ç»‡ç»“æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ—‚ï¸-æ–‡ä»¶ç»„ç»‡ç»“æ„"><span>ğŸ—‚ï¸ <strong>æ–‡ä»¶ç»„ç»‡ç»“æ„</strong></span></a></h3><div class="language-text line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="text" style="--vp-collapsed-lines:15;"><pre><code class="language-text"><span class="line">module/auth/</span>
<span class="line">â”œâ”€â”€ controller/</span>
<span class="line">â”‚   â”œâ”€â”€ AuthController.java          # è®¤è¯æ¥å£ï¼ˆç™»å½•/æ³¨å†Œï¼‰</span>
<span class="line">â”‚   â””â”€â”€ UserController.java          # ç”¨æˆ·ç®¡ç†æ¥å£</span>
<span class="line">â”œâ”€â”€ service/</span>
<span class="line">â”‚   â”œâ”€â”€ AuthService.java             # è®¤è¯æœåŠ¡æ¥å£</span>
<span class="line">â”‚   â”œâ”€â”€ AuthServiceImpl.java         # è®¤è¯æœåŠ¡å®ç°</span>
<span class="line">â”‚   â”œâ”€â”€ UserService.java             # ç”¨æˆ·æœåŠ¡æ¥å£</span>
<span class="line">â”‚   â”œâ”€â”€ UserServiceImpl.java         # ç”¨æˆ·æœåŠ¡å®ç°</span>
<span class="line">â”‚   â””â”€â”€ UserDetailsServiceImpl.java  # Spring Security ç”¨æˆ·åŠ è½½</span>
<span class="line">â”œâ”€â”€ mapper/</span>
<span class="line">â”‚   â”œâ”€â”€ UserMapper.java              # ç”¨æˆ·æ•°æ®è®¿é—®</span>
<span class="line">â”‚   â”œâ”€â”€ RoleMapper.java              # è§’è‰²æ•°æ®è®¿é—®</span>
<span class="line">â”‚   â””â”€â”€ UserRoleMapper.java          # ç”¨æˆ·è§’è‰²å…³è”</span>
<span class="line">â”œâ”€â”€ entity/</span>
<span class="line">â”‚   â”œâ”€â”€ User.java                    # ç”¨æˆ·å®ä½“</span>
<span class="line">â”‚   â”œâ”€â”€ Role.java                    # è§’è‰²å®ä½“</span>
<span class="line">â”‚   â””â”€â”€ UserRole.java                # ç”¨æˆ·è§’è‰²å…³è”å®ä½“</span>
<span class="line">â”œâ”€â”€ dto/</span>
<span class="line">â”‚   â”œâ”€â”€ LoginDTO.java                # ç™»å½•è¯·æ±‚</span>
<span class="line">â”‚   â”œâ”€â”€ RegisterDTO.java             # æ³¨å†Œè¯·æ±‚</span>
<span class="line">â”‚   â””â”€â”€ ChangePasswordDTO.java       # ä¿®æ”¹å¯†ç è¯·æ±‚</span>
<span class="line">â””â”€â”€ vo/</span>
<span class="line">    â”œâ”€â”€ LoginVO.java                 # ç™»å½•å“åº”</span>
<span class="line">    â””â”€â”€ UserProfileVO.java           # ç”¨æˆ·ä¿¡æ¯å“åº”</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><hr><h2 id="_2-spring-security-æ ¸å¿ƒæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-spring-security-æ ¸å¿ƒæœºåˆ¶"><span>2. Spring Security æ ¸å¿ƒæœºåˆ¶</span></a></h2><h3 id="ğŸ”’-spring-security-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ”’-spring-security-æ˜¯ä»€ä¹ˆ"><span>ğŸ”’ <strong>Spring Security æ˜¯ä»€ä¹ˆï¼Ÿ</strong></span></a></h3><p>Spring Security æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è®¤è¯å’Œæˆæƒæ¡†æ¶ï¼Œæä¾›ï¼š</p><ul><li>âœ… ç”¨æˆ·è®¤è¯ï¼ˆAuthenticationï¼‰- &quot;ä½ æ˜¯è°ï¼Ÿ&quot;</li><li>âœ… ç”¨æˆ·æˆæƒï¼ˆAuthorizationï¼‰- &quot;ä½ èƒ½åšä»€ä¹ˆï¼Ÿ&quot;</li><li>âœ… é˜²æŠ¤å¸¸è§æ”»å‡»ï¼ˆCSRFã€XSSã€Session Fixationï¼‰</li></ul><h3 id="ğŸ¯-æ ¸å¿ƒç»„ä»¶è§£æ" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ ¸å¿ƒç»„ä»¶è§£æ"><span>ğŸ¯ <strong>æ ¸å¿ƒç»„ä»¶è§£æ</strong></span></a></h3><h4 id="_1-securityfilterchain-å®‰å…¨è¿‡æ»¤å™¨é“¾" tabindex="-1"><a class="header-anchor" href="#_1-securityfilterchain-å®‰å…¨è¿‡æ»¤å™¨é“¾"><span><strong>1. SecurityFilterChain - å®‰å…¨è¿‡æ»¤å™¨é“¾</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    http</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token class-name">AbstractHttpConfigurer</span><span class="token operator">::</span><span class="token function">disable</span><span class="token punctuation">)</span>  <span class="token comment">// â‘  ç¦ç”¨ CSRF</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span>session <span class="token operator">-&gt;</span>            <span class="token comment">// â‘¡ æ— çŠ¶æ€ä¼šè¯</span></span>
<span class="line">            session<span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">STATELESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span>auth <span class="token operator">-&gt;</span> auth      <span class="token comment">// â‘¢ è®¿é—®æ§åˆ¶</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/auth/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>jwtFilter<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// â‘£ æ·»åŠ è‡ªå®šä¹‰è¿‡æ»¤å™¨</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å·¥ä½œåŸç†ï¼š</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">HTTP è¯·æ±‚</span>
<span class="line">    â†“</span>
<span class="line">â‘  CSRF é˜²æŠ¤è¿‡æ»¤å™¨ (å·²ç¦ç”¨)</span>
<span class="line">    â†“</span>
<span class="line">â‘¡ Session ç®¡ç†è¿‡æ»¤å™¨ (æ— çŠ¶æ€)</span>
<span class="line">    â†“</span>
<span class="line">â‘¢ JWT è®¤è¯è¿‡æ»¤å™¨ (æˆ‘ä»¬è‡ªå®šä¹‰çš„) â­</span>
<span class="line">    â†“</span>
<span class="line">â‘£ æˆæƒè¿‡æ»¤å™¨ (æ£€æŸ¥æƒé™)</span>
<span class="line">    â†“</span>
<span class="line">â‘¤ Controller å¤„ç†è¯·æ±‚</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-authenticationmanager-è®¤è¯ç®¡ç†å™¨" tabindex="-1"><a class="header-anchor" href="#_2-authenticationmanager-è®¤è¯ç®¡ç†å™¨"><span><strong>2. AuthenticationManager - è®¤è¯ç®¡ç†å™¨</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManager</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">AuthenticationConfiguration</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> config<span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä½œç”¨ï¼š</strong> è´Ÿè´£éªŒè¯ç”¨æˆ·å‡­è¯ï¼ˆç”¨æˆ·å + å¯†ç ï¼‰</p><p><strong>å·¥ä½œæµç¨‹ï¼š</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">ç”¨æˆ·æäº¤ç™»å½•è¡¨å•</span>
<span class="line">    â†“</span>
<span class="line">åˆ›å»º UsernamePasswordAuthenticationToken</span>
<span class="line">    â†“</span>
<span class="line">AuthenticationManager.authenticate()</span>
<span class="line">    â†“</span>
<span class="line">è°ƒç”¨ AuthenticationProvider</span>
<span class="line">    â†“</span>
<span class="line">ä½¿ç”¨ UserDetailsService åŠ è½½ç”¨æˆ·</span>
<span class="line">    â†“</span>
<span class="line">ä½¿ç”¨ PasswordEncoder éªŒè¯å¯†ç </span>
<span class="line">    â†“</span>
<span class="line">è¿”å› Authentication å¯¹è±¡ï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œæƒé™ï¼‰</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-authenticationprovider-è®¤è¯æä¾›è€…" tabindex="-1"><a class="header-anchor" href="#_3-authenticationprovider-è®¤è¯æä¾›è€…"><span><strong>3. AuthenticationProvider - è®¤è¯æä¾›è€…</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">AuthenticationProvider</span> <span class="token function">authenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">DaoAuthenticationProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DaoAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    provider<span class="token punctuation">.</span><span class="token function">setUserDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// â­ å¦‚ä½•åŠ è½½ç”¨æˆ·</span></span>
<span class="line">    provider<span class="token punctuation">.</span><span class="token function">setPasswordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// â­ å¦‚ä½•éªŒè¯å¯†ç </span></span>
<span class="line">    <span class="token keyword">return</span> provider<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å…³é”®é…ç½®ï¼š</strong></p><ul><li><code>UserDetailsService</code> - ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·</li><li><code>PasswordEncoder</code> - BCrypt å¯†ç éªŒè¯å™¨</li></ul><h4 id="_4-userdetailsservice-ç”¨æˆ·åŠ è½½æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#_4-userdetailsservice-ç”¨æˆ·åŠ è½½æœåŠ¡"><span><strong>4. UserDetailsService - ç”¨æˆ·åŠ è½½æœåŠ¡</strong></span></a></h4><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// â‘  ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·</span></span>
<span class="line">        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;User not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// â‘¡ æŸ¥è¯¢ç”¨æˆ·æƒé™</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectPermissionsByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// â‘¢ è¿”å› Spring Security éœ€è¦çš„ UserDetails å¯¹è±¡</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SecurityUser</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><strong>SecurityUser - è‡ªå®šä¹‰ UserDetails å®ç°ï¼š</strong></p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityUser</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>              <span class="token comment">// ç”¨æˆ·IDï¼ˆé¢å¤–ä¿¡æ¯ï¼‰</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>          <span class="token comment">// ç”¨æˆ·å</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>          <span class="token comment">// å¯†ç ï¼ˆåŠ å¯†åçš„ï¼‰</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> enabled<span class="token punctuation">;</span>          <span class="token comment">// æ˜¯å¦å¯ç”¨</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>  <span class="token comment">// æƒé™åˆ—è¡¨</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> authorities<span class="token punctuation">;</span>  <span class="token comment">// â­ Spring Security ç”¨è¿™ä¸ªåˆ¤æ–­æƒé™</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> password<span class="token punctuation">;</span>  <span class="token comment">// â­ Spring Security ç”¨è¿™ä¸ªéªŒè¯å¯†ç </span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> enabled<span class="token punctuation">;</span>  <span class="token comment">// â­ è´¦å·æ˜¯å¦å¯ç”¨</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h4 id="_5-passwordencoder-å¯†ç åŠ å¯†å™¨" tabindex="-1"><a class="header-anchor" href="#_5-passwordencoder-å¯†ç åŠ å¯†å™¨"><span><strong>5. PasswordEncoder - å¯†ç åŠ å¯†å™¨</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ä½¿ç”¨ BCrypt ç®—æ³•</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>BCrypt ç‰¹ç‚¹ï¼š</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">&quot;Admin@123&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ³¨å†Œæ—¶ï¼šåŠ å¯†å¯†ç </span></span>
<span class="line"><span class="token class-name">String</span> hash1 <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ç»“æœ: $2a$10$N.zmdr9k7uOCQb376NoUn...</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åŒæ ·çš„å¯†ç å†æ¬¡åŠ å¯†ï¼Œç»“æœä¸åŒï¼ï¼ˆè‡ªåŠ¨åŠ ç›ï¼‰</span></span>
<span class="line"><span class="token class-name">String</span> hash2 <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ç»“æœ: $2a$10$K.abcd1234567890XYZ...</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç™»å½•æ—¶ï¼šéªŒè¯å¯†ç </span></span>
<span class="line"><span class="token keyword">boolean</span> isMatch <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span></span>
<span class="line"><span class="token keyword">boolean</span> isMatch2 <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸ºä»€ä¹ˆåŒä¸€ä¸ªå¯†ç æ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒï¼Ÿ</strong></p><ul><li>BCrypt è‡ªåŠ¨ç”Ÿæˆéšæœºç›ï¼ˆSaltï¼‰</li><li>ç›å€¼å­˜å‚¨åœ¨å¯†æ–‡ä¸­ï¼ˆ<code>$2a$10$</code> åé¢çš„éƒ¨åˆ†ï¼‰</li><li>éªŒè¯æ—¶è‡ªåŠ¨æå–ç›å€¼ï¼Œé‡æ–°è®¡ç®—æ¯”å¯¹</li></ul><hr><h2 id="_3-jwt-è®¤è¯æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_3-jwt-è®¤è¯æµç¨‹"><span>3. JWT è®¤è¯æµç¨‹</span></a></h2><h3 id="ğŸ«-jwt-json-web-token-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ«-jwt-json-web-token-æ˜¯ä»€ä¹ˆ"><span>ğŸ« <strong>JWT (JSON Web Token) æ˜¯ä»€ä¹ˆï¼Ÿ</strong></span></a></h3><p>JWT æ˜¯ä¸€ç§æ— çŠ¶æ€çš„è®¤è¯æ–¹å¼ï¼Œä¸éœ€è¦æœåŠ¡å™¨å­˜å‚¨ Sessionã€‚</p><p><strong>JWT ç»“æ„ï¼š</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6MTY0MDk5OTk5OX0.signature</span>
<span class="line"></span>
<span class="line">â”‚                                     â”‚                                  â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€ Signature</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸‰éƒ¨åˆ†ç»„æˆï¼š</strong></p><ol><li><p><strong>Header</strong> - ç®—æ³•ç±»å‹</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>Payload</strong> - ç”¨æˆ·æ•°æ®</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;sub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span>        <span class="token comment">// ç”¨æˆ·å</span></span>
<span class="line">  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1640999999</span><span class="token punctuation">,</span>     <span class="token comment">// è¿‡æœŸæ—¶é—´</span></span>
<span class="line">  <span class="token property">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token number">1640900000</span>      <span class="token comment">// ç­¾å‘æ—¶é—´</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>Signature</strong> - ç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">HMACSHA256(</span>
<span class="line">  base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload),</span>
<span class="line">  secret_key</span>
<span class="line">)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="ğŸ”§-jwtutil-jwt-å·¥å…·ç±»" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-jwtutil-jwt-å·¥å…·ç±»"><span>ğŸ”§ <strong>JwtUtil - JWT å·¥å…·ç±»</strong></span></a></h3><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtil</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">JwtProperties</span> jwtProperties<span class="token punctuation">;</span>  <span class="token comment">// è¯»å–é…ç½®</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘  ç”Ÿæˆ Token</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Date</span> expiration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> jwtProperties<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// è®¾ç½®ç”¨æˆ·å</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>                           <span class="token comment">// ç­¾å‘æ—¶é—´</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>expiration<span class="token punctuation">)</span>                  <span class="token comment">// è¿‡æœŸæ—¶é—´</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token function">getSigningKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">)</span>  <span class="token comment">// ç­¾å</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¡ éªŒè¯ Token</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">extractUsername</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>username<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isTokenExpired</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¢ æå–ç”¨æˆ·å</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">extractUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">extractClaim</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">Claims</span><span class="token operator">::</span><span class="token function">getSubject</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘£ æ£€æŸ¥æ˜¯å¦è¿‡æœŸ</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">isTokenExpired</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">extractExpiration</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è·å–ç­¾åå¯†é’¥</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SecretKey</span> <span class="token function">getSigningKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes <span class="token operator">=</span> jwtProperties<span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Keys</span><span class="token punctuation">.</span><span class="token function">hmacShaKeyFor</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><strong>é…ç½®æ–‡ä»¶ï¼š</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">jwt</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">secret</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>256<span class="token punctuation">-</span>bit<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>key<span class="token punctuation">-</span>change<span class="token punctuation">-</span>this<span class="token punctuation">-</span>in<span class="token punctuation">-</span>production  <span class="token comment"># å¯†é’¥ï¼ˆè‡³å°‘256ä½ï¼‰</span></span>
<span class="line">  <span class="token key atrule">expiration</span><span class="token punctuation">:</span> <span class="token number">604800000</span>  <span class="token comment"># è¿‡æœŸæ—¶é—´ï¼š7å¤©ï¼ˆæ¯«ç§’ï¼‰</span></span>
<span class="line">  <span class="token key atrule">header</span><span class="token punctuation">:</span> Authorization  <span class="token comment"># HTTP Header åç§°</span></span>
<span class="line">  <span class="token key atrule">prefix</span><span class="token punctuation">:</span> Bearer         <span class="token comment"># Token å‰ç¼€</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ›¡ï¸-jwtauthenticationfilter-jwt-è¿‡æ»¤å™¨" tabindex="-1"><a class="header-anchor" href="#ğŸ›¡ï¸-jwtauthenticationfilter-jwt-è¿‡æ»¤å™¨"><span>ğŸ›¡ï¸ <strong>JwtAuthenticationFilter - JWT è¿‡æ»¤å™¨</strong></span></a></h3><p>è¿™æ˜¯æ•´ä¸ªè®¤è¯æœºåˆ¶çš„æ ¸å¿ƒï¼</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">JwtUtil</span> jwtUtil<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// â‘  ä»è¯·æ±‚å¤´æå– JWT Token</span></span>
<span class="line">        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">extractTokenFromRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> jwtUtil<span class="token punctuation">.</span><span class="token function">validateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¡ ä» Token æå–ç”¨æˆ·å</span></span>
<span class="line">            <span class="token class-name">String</span> username <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">extractUsername</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¢ åŠ è½½ç”¨æˆ·è¯¦æƒ…</span></span>
<span class="line">            <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘£ åˆ›å»ºè®¤è¯å¯¹è±¡</span></span>
<span class="line">            <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span></span>
<span class="line">                    userDetails<span class="token punctuation">,</span>              <span class="token comment">// principalï¼ˆä¸»ä½“ï¼‰</span></span>
<span class="line">                    <span class="token keyword">null</span><span class="token punctuation">,</span>                     <span class="token comment">// credentialsï¼ˆå‡­è¯ï¼Œä¸éœ€è¦ï¼‰</span></span>
<span class="line">                    userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// authoritiesï¼ˆæƒé™ï¼‰</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¤ è®¾ç½®åˆ° SecurityContextï¼ˆSpring Security çš„ä¸Šä¸‹æ–‡ï¼‰</span></span>
<span class="line">            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// â‘¥ ç»§ç»­è¿‡æ»¤å™¨é“¾</span></span>
<span class="line">        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä» HTTP Header æå– Token</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">extractTokenFromRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> bearerToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bearerToken <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bearerToken<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> bearerToken<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// å»æ‰ &quot;Bearer &quot; å‰ç¼€</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><strong>å·¥ä½œæµç¨‹å›¾ï¼š</strong></p><div class="language-text line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="text" style="--vp-collapsed-lines:15;"><pre><code class="language-text"><span class="line">HTTP è¯·æ±‚</span>
<span class="line">    â†“</span>
<span class="line">æ£€æŸ¥ Authorization Header</span>
<span class="line">    â†“</span>
<span class="line">æå– JWT Token</span>
<span class="line">    â†“</span>
<span class="line">éªŒè¯ Token æœ‰æ•ˆæ€§</span>
<span class="line">    â”œâ”€ æ— æ•ˆ â†’ ç»§ç»­ï¼ˆä¸è®¾ç½®è®¤è¯ï¼‰</span>
<span class="line">    â””â”€ æœ‰æ•ˆ â†“</span>
<span class="line">        æå–ç”¨æˆ·å</span>
<span class="line">        â†“</span>
<span class="line">        åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆUserDetailsServiceï¼‰</span>
<span class="line">        â†“</span>
<span class="line">        åˆ›å»º Authentication å¯¹è±¡</span>
<span class="line">        â†“</span>
<span class="line">        å­˜å…¥ SecurityContext</span>
<span class="line">        â†“</span>
<span class="line">        åç»­ Controller å¯é€šè¿‡ SecurityUtil è·å–å½“å‰ç”¨æˆ·</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><hr><h2 id="_4-mybatis-plus-æ•°æ®å±‚" tabindex="-1"><a class="header-anchor" href="#_4-mybatis-plus-æ•°æ®å±‚"><span>4. MyBatis-Plus æ•°æ®å±‚</span></a></h2><h3 id="ğŸ—„ï¸-mybatis-plus-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ—„ï¸-mybatis-plus-æ˜¯ä»€ä¹ˆ"><span>ğŸ—„ï¸ <strong>MyBatis-Plus æ˜¯ä»€ä¹ˆï¼Ÿ</strong></span></a></h3><p>MyBatis-Plus æ˜¯ MyBatis çš„å¢å¼ºå·¥å…·ï¼Œæä¾›ï¼š</p><ul><li>âœ… <strong>CRUD æ¥å£</strong>ï¼šç»§æ‰¿ <code>BaseMapper</code> å³å¯ä½¿ç”¨</li><li>âœ… <strong>æ¡ä»¶æ„é€ å™¨</strong>ï¼šç±»å‹å®‰å…¨çš„ SQL æ„å»º</li><li>âœ… <strong>åˆ†é¡µæ’ä»¶</strong>ï¼šè‡ªåŠ¨åˆ†é¡µ</li><li>âœ… <strong>ä»£ç ç”Ÿæˆå™¨</strong>ï¼šè‡ªåŠ¨ç”Ÿæˆ Entityã€Mapper</li></ul><h3 id="ğŸ“-usermapper-ç”¨æˆ·æ•°æ®è®¿é—®" tabindex="-1"><a class="header-anchor" href="#ğŸ“-usermapper-ç”¨æˆ·æ•°æ®è®¿é—®"><span>ğŸ“ <strong>UserMapper - ç”¨æˆ·æ•°æ®è®¿é—®</strong></span></a></h3><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Mapper</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ========== MyBatis-Plus å†…ç½®æ–¹æ³•ï¼ˆæ— éœ€å®ç°ï¼‰==========</span></span>
<span class="line">    <span class="token comment">// insert(User user)              - æ’å…¥</span></span>
<span class="line">    <span class="token comment">// deleteById(Long id)            - åˆ é™¤</span></span>
<span class="line">    <span class="token comment">// updateById(User user)          - æ›´æ–°</span></span>
<span class="line">    <span class="token comment">// selectById(Long id)            - æŸ¥è¯¢å•ä¸ª</span></span>
<span class="line">    <span class="token comment">// selectList(Wrapper&lt;User&gt;)      - æŸ¥è¯¢åˆ—è¡¨</span></span>
<span class="line">    <span class="token comment">// selectPage(Page, Wrapper)      - åˆ†é¡µæŸ¥è¯¢</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ========== è‡ªå®šä¹‰æ–¹æ³• ==========</span></span>
<span class="line">    </span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT COUNT(*) &gt; 0 FROM users WHERE username = #{username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">boolean</span> <span class="token function">existsByUsername</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT COUNT(*) &gt; 0 FROM users WHERE email = #{email}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">boolean</span> <span class="token function">existsByEmail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * æŸ¥è¯¢ç”¨æˆ·æƒé™</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">        SELECT DISTINCT p.code</span>
<span class="line">        FROM permissions p</span>
<span class="line">        INNER JOIN role_permissions rp ON p.id = rp.permission_id</span>
<span class="line">        INNER JOIN user_roles ur ON rp.role_id = ur.role_id</span>
<span class="line">        WHERE ur.user_id = #{userId}</span>
<span class="line">    &quot;&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectPermissionsByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * æŸ¥è¯¢ç”¨æˆ·è§’è‰²</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">        SELECT DISTINCT r.code</span>
<span class="line">        FROM roles r</span>
<span class="line">        INNER JOIN user_roles ur ON r.id = ur.role_id</span>
<span class="line">        WHERE ur.user_id = #{userId}</span>
<span class="line">    &quot;&quot;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectRolesByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h3 id="ğŸ”-lambdaquerywrapper-ç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ„é€ å™¨" tabindex="-1"><a class="header-anchor" href="#ğŸ”-lambdaquerywrapper-ç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ„é€ å™¨"><span>ğŸ” <strong>LambdaQueryWrapper - ç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ„é€ å™¨</strong></span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token comment">// âŒ ä¼ ç»Ÿ MyBatis å†™æ³•ï¼ˆå­—ç¬¦ä¸²ï¼Œå®¹æ˜“å‡ºé”™ï¼‰</span></span>
<span class="line"><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM users WHERE username = ?&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// âœ… MyBatis-Plus å†™æ³•ï¼ˆç±»å‹å®‰å…¨ï¼‰</span></span>
<span class="line"><span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">wrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// WHERE username = &#39;admin&#39;</span></span>
<span class="line"><span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´å¤šç¤ºä¾‹ï¼š</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token comment">// æŸ¥è¯¢çŠ¶æ€ä¸º1çš„ç”¨æˆ·</span></span>
<span class="line">wrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ¨¡ç³ŠæŸ¥è¯¢</span></span>
<span class="line">wrapper<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// username LIKE &#39;%admin%&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¤šæ¡ä»¶</span></span>
<span class="line">wrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">       <span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span></span>
<span class="line">       <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getCreatedAt</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆ†é¡µæŸ¥è¯¢</span></span>
<span class="line"><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ç¬¬1é¡µï¼Œæ¯é¡µ10æ¡</span></span>
<span class="line">userMapper<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ—ï¸-baseentity-å®ä½“åŸºç±»" tabindex="-1"><a class="header-anchor" href="#ğŸ—ï¸-baseentity-å®ä½“åŸºç±»"><span>ğŸ—ï¸ <strong>BaseEntity - å®ä½“åŸºç±»</strong></span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Data</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>  <span class="token comment">// ä¸»é”®ï¼Œè‡ªå¢</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;created_at&quot;</span><span class="token punctuation">,</span> fill <span class="token operator">=</span> <span class="token class-name">FieldFill</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createdAt<span class="token punctuation">;</span>  <span class="token comment">// åˆ›å»ºæ—¶é—´ï¼Œæ’å…¥æ—¶è‡ªåŠ¨å¡«å……</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;updated_at&quot;</span><span class="token punctuation">,</span> fill <span class="token operator">=</span> <span class="token class-name">FieldFill</span><span class="token punctuation">.</span><span class="token constant">INSERT_UPDATE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> updatedAt<span class="token punctuation">;</span>  <span class="token comment">// æ›´æ–°æ—¶é—´ï¼Œæ’å…¥å’Œæ›´æ–°æ—¶è‡ªåŠ¨å¡«å……</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è‡ªåŠ¨å¡«å……å¤„ç†å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMetaObjectHandler</span> <span class="token keyword">implements</span> <span class="token class-name">MetaObjectHandler</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertFill</span><span class="token punctuation">(</span><span class="token class-name">MetaObject</span> metaObject<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strictInsertFill</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> <span class="token string">&quot;createdAt&quot;</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strictInsertFill</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> <span class="token string">&quot;updatedAt&quot;</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateFill</span><span class="token punctuation">(</span><span class="token class-name">MetaObject</span> metaObject<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">strictUpdateFill</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">,</span> <span class="token string">&quot;updatedAt&quot;</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_5-æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#_5-æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘"><span>5. æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘</span></a></h2><h3 id="ğŸ”-authservice-è®¤è¯æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#ğŸ”-authservice-è®¤è¯æœåŠ¡"><span>ğŸ” <strong>AuthService - è®¤è¯æœåŠ¡</strong></span></a></h3><h4 id="ç™»å½•æµç¨‹å®ç°" tabindex="-1"><a class="header-anchor" href="#ç™»å½•æµç¨‹å®ç°"><span><strong>ç™»å½•æµç¨‹å®ç°</strong></span></a></h4><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">JwtUtil</span> jwtUtil<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">UserMapper</span> userMapper<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">LoginVO</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginDTO</span> loginDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// â‘  æ£€æŸ¥ç™»å½•å°è¯•æ¬¡æ•°ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰</span></span>
<span class="line">        <span class="token function">checkLoginAttempts</span><span class="token punctuation">(</span>loginDTO<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// â‘¡ åˆ›å»ºè®¤è¯ä»¤ç‰Œ</span></span>
<span class="line">            <span class="token class-name">UsernamePasswordAuthenticationToken</span> authToken <span class="token operator">=</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span></span>
<span class="line">                    loginDTO<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    loginDTO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// åŸå§‹å¯†ç ï¼ˆæ˜æ–‡ï¼‰</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¢ æ‰§è¡Œè®¤è¯ï¼ˆSpring Security è‡ªåŠ¨éªŒè¯å¯†ç ï¼‰</span></span>
<span class="line">            <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘£ è®¤è¯æˆåŠŸï¼Œé‡ç½®ç™»å½•å°è¯•</span></span>
<span class="line">            <span class="token function">resetLoginAttempts</span><span class="token punctuation">(</span>loginDTO<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¤ è·å–è®¤è¯åçš„ç”¨æˆ·ä¿¡æ¯</span></span>
<span class="line">            <span class="token class-name">SecurityUser</span> securityUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityUser</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¥ ç”Ÿæˆ JWT Token</span></span>
<span class="line">            <span class="token class-name">String</span> token <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¦ æ›´æ–°æœ€åç™»å½•æ—¶é—´</span></span>
<span class="line">            <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            user<span class="token punctuation">.</span><span class="token function">setLastLoginAt</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            userMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘§ æŸ¥è¯¢ç”¨æˆ·è§’è‰²å’Œæƒé™</span></span>
<span class="line">            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectRolesByUserId</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectPermissionsByUserId</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// â‘¨ æ„å»ºè¿”å›ç»“æœ</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">LoginVO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">tokenType</span><span class="token punctuation">(</span><span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">expiresAt</span><span class="token punctuation">(</span><span class="token function">calculateExpirationTime</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">userInfo</span><span class="token punctuation">(</span><span class="token class-name">LoginVO<span class="token punctuation">.</span>UserInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">nickname</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">avatarUrl</span><span class="token punctuation">(</span>securityUser<span class="token punctuation">.</span><span class="token function">getAvatarUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">permissions</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                </span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// â‘© è®¤è¯å¤±è´¥ï¼Œå¢åŠ å¤±è´¥æ¬¡æ•°</span></span>
<span class="line">            <span class="token function">incrementLoginAttempts</span><span class="token punctuation">(</span>loginDTO<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">INVALID_CREDENTIALS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><h4 id="æ³¨å†Œæµç¨‹å®ç°" tabindex="-1"><a class="header-anchor" href="#æ³¨å†Œæµç¨‹å®ç°"><span><strong>æ³¨å†Œæµç¨‹å®ç°</strong></span></a></h4><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">RegisterDTO</span> registerDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘  æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">existsByUsername</span><span class="token punctuation">(</span>registerDTO<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">USER_ALREADY_EXISTS</span><span class="token punctuation">,</span> </span>
<span class="line">            <span class="token string">&quot;Username already exists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¡ æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>userMapper<span class="token punctuation">.</span><span class="token function">existsByEmail</span><span class="token punctuation">(</span>registerDTO<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">USER_ALREADY_EXISTS</span><span class="token punctuation">,</span> </span>
<span class="line">            <span class="token string">&quot;Email already registered&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¢ åˆ›å»ºç”¨æˆ·å¯¹è±¡</span></span>
<span class="line">    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>registerDTO<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span>registerDTO<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>registerDTO<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> </span>
<span class="line">        registerDTO<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> registerDTO<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘£ åŠ å¯†å¯†ç ï¼ˆBCryptï¼‰</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>registerDTO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¤ è®¾ç½®é»˜è®¤å€¼</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">USER_STATUS_ACTIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setEmailVerified</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setPostCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setFollowerCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">setFollowingCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¥ ä¿å­˜åˆ°æ•°æ®åº“</span></span>
<span class="line">    userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¦ åˆ†é…é»˜è®¤è§’è‰²ï¼ˆREADERï¼‰</span></span>
<span class="line">    <span class="token function">assignDefaultRole</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;User registered successfully: {}&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">assignDefaultRole</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Role</span> readerRole <span class="token operator">=</span> roleMapper<span class="token punctuation">.</span><span class="token function">selectByCode</span><span class="token punctuation">(</span><span class="token string">&quot;ROLE_READER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>readerRole <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserRole</span> userRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        userRole<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        userRole<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span>readerRole<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        userRoleMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>userRole<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><hr><h2 id="_6-å®‰å…¨ç‰¹æ€§è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_6-å®‰å…¨ç‰¹æ€§è¯¦è§£"><span>6. å®‰å…¨ç‰¹æ€§è¯¦è§£</span></a></h2><h3 id="ğŸ›¡ï¸-é˜²æš´åŠ›ç ´è§£-ç™»å½•é™åˆ¶" tabindex="-1"><a class="header-anchor" href="#ğŸ›¡ï¸-é˜²æš´åŠ›ç ´è§£-ç™»å½•é™åˆ¶"><span>ğŸ›¡ï¸ <strong>é˜²æš´åŠ›ç ´è§£ - ç™»å½•é™åˆ¶</strong></span></a></h3><p>ä½¿ç”¨ Redis è®°å½•ç™»å½•å¤±è´¥æ¬¡æ•°ï¼š</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkLoginAttempts</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">KEY_LOGIN_LOCKED</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> attemptsKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">KEY_LOGIN_ATTEMPTS</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘  æ£€æŸ¥æ˜¯å¦è¢«é”å®š</span></span>
<span class="line">    <span class="token class-name">Boolean</span> isLocked <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isLocked<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Long</span> ttl <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">getExpire</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">,</span> </span>
<span class="line">            <span class="token string">&quot;Account locked. Try again in &quot;</span> <span class="token operator">+</span> ttl <span class="token operator">+</span> <span class="token string">&quot; minutes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// â‘¡ æ£€æŸ¥å¤±è´¥æ¬¡æ•°</span></span>
<span class="line">    <span class="token class-name">Integer</span> attempts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>attemptsKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>attempts <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> attempts <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// é”å®šè´¦æˆ·30åˆ†é’Ÿ</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>attemptsKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">FORBIDDEN</span><span class="token punctuation">,</span> </span>
<span class="line">            <span class="token string">&quot;Account locked due to too many failed attempts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">incrementLoginAttempts</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">KEY_LOGIN_ATTEMPTS</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 15åˆ†é’Ÿåé‡ç½®</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetLoginAttempts</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> attemptsKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">KEY_LOGIN_ATTEMPTS</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">KEY_LOGIN_LOCKED</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>attemptsKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><strong>Redis å­˜å‚¨ç»“æ„ï¼š</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">login:attempts:admin â†’ 3         (å¤±è´¥æ¬¡æ•°)</span>
<span class="line">login:locked:admin â†’ true        (é”å®šæ ‡è®°)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ”-å¯†ç å®‰å…¨" tabindex="-1"><a class="header-anchor" href="#ğŸ”-å¯†ç å®‰å…¨"><span>ğŸ” <strong>å¯†ç å®‰å…¨</strong></span></a></h3><h4 id="æ³¨å†Œæ—¶-åŠ å¯†å¯†ç " tabindex="-1"><a class="header-anchor" href="#æ³¨å†Œæ—¶-åŠ å¯†å¯†ç "><span><strong>æ³¨å†Œæ—¶ï¼šåŠ å¯†å¯†ç </strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token class-name">String</span> rawPassword <span class="token operator">=</span> <span class="token string">&quot;Admin@123&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">String</span> encrypted <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>rawPassword<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ç»“æœ: $2a$10$N.zmdr9k7uOCQb376NoUn.eLTp5xGVJQwGHKX3lqk9JxYz3h8mK6q</span></span>
<span class="line"></span>
<span class="line">user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// å­˜å‚¨åŠ å¯†åçš„å¯†ç </span></span>
<span class="line">userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç™»å½•æ—¶-è‡ªåŠ¨éªŒè¯" tabindex="-1"><a class="header-anchor" href="#ç™»å½•æ—¶-è‡ªåŠ¨éªŒè¯"><span><strong>ç™»å½•æ—¶ï¼šè‡ªåŠ¨éªŒè¯</strong></span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token comment">// Spring Security ä¼šè‡ªåŠ¨è°ƒç”¨</span></span>
<span class="line"><span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&quot;Admin@123&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// ç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç </span></span>
<span class="line">    <span class="token string">&quot;$2a$10$N.zmdr9k7uOCQb376NoUn.eLTp5xGVJQwGHKX3lqk9JxYz3h8mK6q&quot;</span>  <span class="token comment">// æ•°æ®åº“çš„å¯†æ–‡</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// è¿”å›: true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸš«-token-é»‘åå•-ç™»å‡ºåŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#ğŸš«-token-é»‘åå•-ç™»å‡ºåŠŸèƒ½"><span>ğŸš« <strong>Token é»‘åå• - ç™»å‡ºåŠŸèƒ½</strong></span></a></h3><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="java" style="--vp-collapsed-lines:15;"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> username <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">extractUsername</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Long</span> expiration <span class="token operator">=</span> jwtUtil<span class="token punctuation">.</span><span class="token function">extractExpiration</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å°† Token åŠ å…¥é»‘åå•ï¼Œè¿‡æœŸæ—¶é—´ = Token å‰©ä½™æœ‰æ•ˆæœŸ</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>expiration <span class="token operator">&gt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;token:blacklist:&quot;</span> <span class="token operator">+</span> token<span class="token punctuation">;</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span></span>
<span class="line">            key<span class="token punctuation">,</span> </span>
<span class="line">            username<span class="token punctuation">,</span> </span>
<span class="line">            expiration <span class="token operator">-</span> now<span class="token punctuation">,</span> </span>
<span class="line">            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p><strong>æ£€æŸ¥é»‘åå•ï¼ˆåœ¨ JwtAuthenticationFilter ä¸­ï¼‰ï¼š</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token string">&quot;token:blacklist:&quot;</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Token å·²å¤±æ•ˆ</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_7-å®Œæ•´è¯·æ±‚æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_7-å®Œæ•´è¯·æ±‚æµç¨‹"><span>7. å®Œæ•´è¯·æ±‚æµç¨‹</span></a></h2><h3 id="ğŸ”„-ç™»å½•è¯·æ±‚å®Œæ•´æµç¨‹" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-ç™»å½•è¯·æ±‚å®Œæ•´æµç¨‹"><span>ğŸ”„ <strong>ç™»å½•è¯·æ±‚å®Œæ•´æµç¨‹</strong></span></a></h3><div class="language-text line-numbers-mode has-collapsed-lines collapsed" data-highlighter="prismjs" data-ext="text" style="--vp-collapsed-lines:15;"><pre><code class="language-text"><span class="line">å‰ç«¯å‘é€ç™»å½•è¯·æ±‚</span>
<span class="line">POST /api/auth/login</span>
<span class="line">{</span>
<span class="line">  &quot;username&quot;: &quot;admin&quot;,</span>
<span class="line">  &quot;password&quot;: &quot;Admin@123&quot;</span>
<span class="line">}</span>
<span class="line">    â†“</span>
<span class="line">â‘  Spring Security è¿‡æ»¤å™¨é“¾</span>
<span class="line">    â”œâ”€ JwtAuthenticationFilter (è·³è¿‡ï¼Œå› ä¸ºæ˜¯ç™»å½•æ¥å£)</span>
<span class="line">    â””â”€ å…è®¸è®¿é—®ï¼ˆpermitAllï¼‰</span>
<span class="line">    â†“</span>
<span class="line">â‘¡ AuthController.login()</span>
<span class="line">    â†“</span>
<span class="line">â‘¢ AuthService.login()</span>
<span class="line">    â”œâ”€ æ£€æŸ¥ Redis ç™»å½•å°è¯•æ¬¡æ•°</span>
<span class="line">    â”œâ”€ AuthenticationManager.authenticate()</span>
<span class="line">    â”‚   â”œâ”€ UserDetailsService.loadUserByUsername()</span>
<span class="line">    â”‚   â”‚   â”œâ”€ UserMapper.selectOne()  (æŸ¥è¯¢æ•°æ®åº“)</span>
<span class="line">    â”‚   â”‚   â””â”€ è¿”å› SecurityUser</span>
<span class="line">    â”‚   â”œâ”€ PasswordEncoder.matches()  (éªŒè¯å¯†ç )</span>
<span class="line">    â”‚   â””â”€ è¿”å› Authentication å¯¹è±¡</span>
<span class="line">    â”œâ”€ JwtUtil.generateToken()  (ç”Ÿæˆ Token)</span>
<span class="line">    â”œâ”€ UserMapper.updateById()  (æ›´æ–°æœ€åç™»å½•æ—¶é—´)</span>
<span class="line">    â””â”€ æ„å»º LoginVO</span>
<span class="line">    â†“</span>
<span class="line">â‘£ è¿”å› JSON å“åº”</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div>`,99)]))}const u=s(t,[["render",l]]),r=JSON.parse('{"path":"/zh/project/Auth%20%E6%A8%A1%E5%9D%97%E5%AE%8C%E6%95%B4%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90.html","title":"ğŸ” Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ","lang":"zh-CN","frontmatter":{"description":"å¥½çš„ï¼è®©æˆ‘ä¸ºä½ è¯¦ç»†ä»‹ç»æˆ‘ä»¬å·²ç»å®Œæˆçš„ Auth æ¨¡å—çš„æŠ€æœ¯æ¶æ„å’Œå®ç°åŸç†ï¼š ğŸ” Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ ğŸ“š ç›®å½• æ¨¡å—æ¶æ„æ€»è§ˆ Spring Security æ ¸å¿ƒæœºåˆ¶ JWT è®¤è¯æµç¨‹ MyBatis-Plus æ•°æ®å±‚ æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘ å®‰å…¨ç‰¹æ€§è¯¦è§£ å®Œæ•´è¯·æ±‚æµç¨‹ 1. æ¨¡å—æ¶æ„æ€»è§ˆ ğŸ“¦ åˆ†å±‚æ¶æ„ ğŸ—‚ï¸ æ–‡ä»¶ç»„ç»‡ç»“æ„ 2. Spring S...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ğŸ” Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-10-08T06:43:07.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"GALA-Lin\\",\\"url\\":\\"https://gala-lin.github.io\\"}]}"],["meta",{"property":"og:url","content":"https://gala-lin.github.io/zh/project/Auth%20%E6%A8%A1%E5%9D%97%E5%AE%8C%E6%95%B4%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90.html"}],["meta",{"property":"og:site_name","content":"22lin04"}],["meta",{"property":"og:title","content":"ğŸ” Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ"}],["meta",{"property":"og:description","content":"å¥½çš„ï¼è®©æˆ‘ä¸ºä½ è¯¦ç»†ä»‹ç»æˆ‘ä»¬å·²ç»å®Œæˆçš„ Auth æ¨¡å—çš„æŠ€æœ¯æ¶æ„å’Œå®ç°åŸç†ï¼š ğŸ” Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ ğŸ“š ç›®å½• æ¨¡å—æ¶æ„æ€»è§ˆ Spring Security æ ¸å¿ƒæœºåˆ¶ JWT è®¤è¯æµç¨‹ MyBatis-Plus æ•°æ®å±‚ æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘ å®‰å…¨ç‰¹æ€§è¯¦è§£ å®Œæ•´è¯·æ±‚æµç¨‹ 1. æ¨¡å—æ¶æ„æ€»è§ˆ ğŸ“¦ åˆ†å±‚æ¶æ„ ğŸ—‚ï¸ æ–‡ä»¶ç»„ç»‡ç»“æ„ 2. Spring S..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-10-08T06:43:07.000Z"}],["meta",{"property":"article:modified_time","content":"2025-10-08T06:43:07.000Z"}]]},"git":{"createdTime":1759905787000,"updatedTime":1759905787000,"contributors":[{"name":"Linsen HU","username":"","email":"1563883475@qq.com","commits":1}]},"readingTime":{"minutes":9.53,"words":2860},"filePathRelative":"zh/project/Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ.md","excerpt":"<p>å¥½çš„ï¼è®©æˆ‘ä¸ºä½ è¯¦ç»†ä»‹ç»æˆ‘ä»¬å·²ç»å®Œæˆçš„ <strong>Auth æ¨¡å—</strong>çš„æŠ€æœ¯æ¶æ„å’Œå®ç°åŸç†ï¼š</p>\\n<hr>\\n<h1>ğŸ” Auth æ¨¡å—å®Œæ•´æŠ€æœ¯è§£æ</h1>\\n<h2>ğŸ“š ç›®å½•</h2>\\n<ol>\\n<li><a href=\\"https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#1-%E6%A8%A1%E5%9D%97%E6%9E%B6%E6%9E%84%E6%80%BB%E8%A7%88\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">æ¨¡å—æ¶æ„æ€»è§ˆ</a></li>\\n<li><a href=\\"https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#2-spring-security-%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Spring Security æ ¸å¿ƒæœºåˆ¶</a></li>\\n<li><a href=\\"https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#3-jwt-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">JWT è®¤è¯æµç¨‹</a></li>\\n<li><a href=\\"https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#4-mybatis-plus-%E6%95%B0%E6%8D%AE%E5%B1%82\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">MyBatis-Plus æ•°æ®å±‚</a></li>\\n<li><a href=\\"https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#5-%E6%9C%8D%E5%8A%A1%E5%B1%82%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘</a></li>\\n<li><a href=\\"https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#6-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">å®‰å…¨ç‰¹æ€§è¯¦è§£</a></li>\\n<li><a href=\\"https://claude.ai/chat/16a4c146-a269-41c4-8385-2b4e4a0a9d5d#7-%E5%AE%8C%E6%95%B4%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">å®Œæ•´è¯·æ±‚æµç¨‹</a></li>\\n</ol>","autoDesc":true}');export{u as comp,r as data};
